# XC-Ecosystem — Development Log
### Date: 2025-12-02
### Session: Dark Layout, Team Management, and Final Stripe Wiring

## Overview
This session built on the prior billing/routing work and focused on three major themes:

1. Unifying the UI with a **dark global layout**.
2. Completing the **Team Management (program staff)** module.
3. Finalizing **Stripe program-level billing** so subscription changes flow cleanly from Stripe → Supabase → UI.

By the end of the session, the app had a fully working multi-program, program-level billing loop and a production-grade team + billing experience.

---

## Completed Work

### 1. Global Dark Layout

- Implemented `app/layout.tsx` as the global shell:
  - Dark header with logo and app name.
  - Navigation links:
    - `/dashboard`
    - `/onboarding/coach`
    - `/onboarding/athlete`
    - `/debug/program-billing`
  - Shared page container with consistent spacing.
- Removed duplicated per-page header patterns in favor of this shared layout.

### 2. Dashboard Restyle

- Updated `app/dashboard/page.tsx` to match the new dark theme:
  - Account card showing:
    - User full name or email.
    - Optional `roleHint` from `/api/me`.
  - Athlete subscription card showing plan, status, and renewal date.
  - Programs section listing all attached programs with actions:
    - **Overview** → `/programs/[programId]` (future work)
    - **Team** → `/programs/[programId]/staff`
    - **Manage billing** → `/programs/[programId]/billing`
- Integrated better empty, loading, and error states.

### 3. Team Management (Program Staff)

- Implemented `GET /api/programs/[programId]/staff`:
  - Validates that the current user is a `program_members` member of the program.
  - Returns staff rows with `email`, `role`, and `joinedAt`.
- Implemented `PATCH /api/programs/[programId]/staff/[memberId]`:
  - Parses `programId` and `memberId` from the URL to avoid Next.js 16 `params` typing issues.
  - Updates the staff member’s `role` in `program_members`.
- Implemented `DELETE /api/programs/[programId]/staff/[memberId]`:
  - Validates membership.
  - Deletes the member row from `program_members`.
- Implemented `app/programs/[programId]/staff/page.tsx`:
  - Dark-themed table of staff.
  - `<select>` to edit roles, wired to PATCH.
  - Remove button wired to DELETE.
  - Loading and error handling.
  - “Invite staff (coming soon)” placeholder.

This module provides a clean, finished experience for managing program staff.

### 4. Program Billing UI with Live Stripe Actions

- Upgraded `app/programs/[programId]/billing/page.tsx`:
  - Shows current plan, status, and renewal based on `program_subscriptions`.
  - Allows users to select desired plan:
    - `college_starter`
    - `college_pro`
    - `college_elite`
  - Added two functional buttons:
    - **Activate / Change plan in Stripe**:
      - Calls `POST /billing/create-checkout-session` with:
        - `scope: "org"`
        - `ownerId: programId`
        - `planCode: selectedPlanCode`
      - Redirects to `body.url` from the API.
    - **Open Stripe customer portal**:
      - Calls `POST /billing/create-portal-session` with:
        - `scope: "org"`
        - `ownerId: programId`
      - Redirects to `body.url`.

### 5. Stripe Webhook Fixes and Alignment

- Rewrote `app/api/stripe/webhook/route.ts` to:
  - Stop using a hard-coded `apiVersion` that conflicted with the installed Stripe types.
  - Properly handle:
    - `customer.subscription.created`
    - `customer.subscription.updated`
    - `customer.subscription.deleted`
  - Read metadata from the Subscription:
    - `scope` (defaults to `"org"`)
    - `owner_id` (programId)
    - `plan_code`
  - Route events to:
    - `program_subscriptions` with `program_id` when `scope === "org"`.
- Fixed `current_period_end` typing by reading it dynamically:
  - `(subscription as any).current_period_end ?? null`
- Logged and skipped subscriptions missing `owner_id` metadata.

### 6. Program Subscriptions DB Constraint

- Added a unique constraint to `program_subscriptions` to support clean upserts:

```sql
ALTER TABLE public.program_subscriptions
ADD CONSTRAINT program_subscriptions_program_id_key
UNIQUE (program_id);
```

- This resolved the Postgres error:

```text
42P10: there is no unique or exclusion constraint matching the ON CONFLICT specification
```

- Now, the webhook can safely call:

```ts
supabaseAdmin.from("program_subscriptions").upsert(payload, {
  onConflict: "program_id",
});
```

without errors.

---

## Testing Completed

- Ran full Vercel build:
  - No TypeScript errors after webhook and route handler fixes.
- Verified Team page:
  - Staff list loads.
  - Role changes persist.
  - Remove action works (where applicable).
- Verified Program Billing page:
  - Shows correct plan from `program_subscriptions`.
  - Launches Stripe Checkout with correct metadata.
  - Launches Stripe Portal successfully.
- Verified Stripe webhook:
  - Processes subscription events without errors.
  - Correctly upserts into `program_subscriptions`.
  - Logs a warning and skips only when metadata is missing (older test subscriptions).

---

## Notes / Decisions

- **Branding**: For beta, we will introduce per-program theming:
  - Custom colors and graphics per school/program.
  - Applied on top of the dark base layout (not yet implemented).
- **Next.js 16 Pattern**:
  - Going forward, dynamic API routes will parse IDs from `req.url` instead of leaning on `context.params` types to avoid future breaking changes.
- **Metadata Contract**:
  - `owner_id`, `scope`, and `plan_code` are now part of the **required contract** between:
    - Billing UI
    - Checkout session creation
    - Stripe webhook
    - Database subscriptions.

---

## Next Steps (Suggested)

1. Implement `/programs/[programId]` Program Overview page:
   - Show snapshot of staff, roster size, board activity, and billing state.
2. Start Roster Management:
   - Create `roster`/`program_athletes` tables and UI.
3. Build the first version of Recruiting Boards:
   - Board lists, stages, and basic evaluation fields.
4. Implement Staff Invitations:
   - Tokenized, expiring invites tied to `program_members`.
