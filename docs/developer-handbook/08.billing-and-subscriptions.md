# Billing & Subscriptions

Billing is handled via Stripe. The application supports **org-level** and **athlete-level** subscriptions.

---

## Data Model

Two main tables:

- `org_subscriptions`
- `athlete_subscriptions`

Each record stores:

- Stripe customer ID
- Stripe subscription ID
- plan code
- status
- current period end
- cancel at period end flag

See `schema.md` for full column definitions.

---

## Flow: Org or Athlete Upgrade

1. User clicks **Upgrade** in the UI.
2. Frontend calls `POST /billing/create-checkout-session` with:
   - `scope` (`"org"` or `"athlete"`)
   - `ownerId` (org_id or user_id)
   - `planCode`
3. Route validates input and creates a Stripe Checkout Session with metadata (scope, ownerId, planCode).
4. User completes checkout on Stripe.
5. Stripe sends `checkout.session.completed` and subscription events to `/api/stripe/webhook`.
6. Webhook verifies signature, reads metadata, and upserts a row in:
   - `org_subscriptions` (if scope = `org`)
   - `athlete_subscriptions` (if scope = `athlete`)
7. `/api/me` reads subscription tables to determine plan and feature access.

---

## Webhook Events

We handle:

- `checkout.session.completed`
- `customer.subscription.created`
- `customer.subscription.updated`
- `customer.subscription.deleted`

The webhook is the **only** place that writes subscription state. UI must never “guess” from Stripe directly.

---

## Plan Codes

Plan codes map to Stripe Price IDs by env vars:

- `hs_athlete_basic`, `hs_athlete_pro`, `hs_athlete_elite`
- `hs_starter`, `hs_pro`, `hs_elite`
- `college_starter`, `college_pro`, `college_elite`

These codes are used across:

- UI feature gating
- `/billing/create-checkout-session`
- Webhook subscription updates

Always keep plan code definitions in sync between Stripe, env vars, and application logic.
