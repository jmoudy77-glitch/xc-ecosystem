-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.absence_determinations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  capability_node_id uuid NOT NULL,
  violation_type text NOT NULL CHECK (violation_type = ANY (ARRAY['coverage'::text, 'redundancy'::text, 'certification'::text, 'authority'::text])),
  horizon text NOT NULL CHECK (horizon = ANY (ARRAY['H0'::text, 'H1'::text, 'H2'::text, 'H3'::text])),
  freeze_marker_id uuid,
  provenance_id uuid,
  audit_link_id uuid,
  evidence_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT absence_determinations_pkey PRIMARY KEY (id),
  CONSTRAINT absence_determinations_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT absence_determinations_capability_node_id_fkey FOREIGN KEY (capability_node_id) REFERENCES public.capability_nodes(id),
  CONSTRAINT absence_determinations_freeze_marker_id_fkey FOREIGN KEY (freeze_marker_id) REFERENCES public.freeze_markers(id),
  CONSTRAINT absence_determinations_provenance_id_fkey FOREIGN KEY (provenance_id) REFERENCES public.provenance_meta(id),
  CONSTRAINT absence_determinations_audit_link_id_fkey FOREIGN KEY (audit_link_id) REFERENCES public.audit_links(id)
);
CREATE TABLE public.ai_causal_ledger (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  canonical_event_id uuid NOT NULL UNIQUE,
  model_version text NOT NULL,
  tier integer NOT NULL CHECK (tier >= 0 AND tier <= 3),
  inputs_fingerprint text NOT NULL,
  drivers_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  confidence numeric CHECK (confidence IS NULL OR confidence >= 0::numeric AND confidence <= 1::numeric),
  data_lineage jsonb NOT NULL DEFAULT '{}'::jsonb,
  output_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ai_causal_ledger_pkey PRIMARY KEY (id),
  CONSTRAINT ai_causal_ledger_canonical_event_id_fkey FOREIGN KEY (canonical_event_id) REFERENCES public.canonical_events(id)
);
CREATE TABLE public.appeal_intake_links (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  determination_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'eligible'::text CHECK (status = ANY (ARRAY['eligible'::text, 'filed'::text, 'reviewing'::text, 'resolved'::text, 'denied'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT appeal_intake_links_pkey PRIMARY KEY (id),
  CONSTRAINT appeal_intake_links_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT appeal_intake_links_determination_fkey FOREIGN KEY (determination_id) REFERENCES public.absence_determinations(id)
);
CREATE TABLE public.athlete_identity_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['created'::text, 'updated'::text, 'duplicate_detected'::text, 'claimed'::text, 'merged'::text])),
  canonical_athlete_id uuid,
  source_athlete_id uuid,
  program_id uuid,
  actor_user_id uuid,
  details jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  canonical_event_id uuid,
  CONSTRAINT athlete_identity_events_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_identity_events_canonical_fkey FOREIGN KEY (canonical_athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT athlete_identity_events_source_fkey FOREIGN KEY (source_athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT athlete_identity_events_program_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT athlete_identity_events_actor_fkey FOREIGN KEY (actor_user_id) REFERENCES public.users(id),
  CONSTRAINT athlete_identity_events_canonical_event_id_fkey FOREIGN KEY (canonical_event_id) REFERENCES public.canonical_events(id)
);
CREATE TABLE public.athlete_inquiries (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  program_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  source_program_id uuid,
  status text NOT NULL DEFAULT 'new'::text,
  message text,
  contact_email text,
  contact_phone text,
  grad_year integer,
  primary_event text,
  pr_blob jsonb,
  coach_notes text,
  requirements text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT athlete_inquiries_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_inquiries_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT athlete_inquiries_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT athlete_inquiries_source_program_id_fkey FOREIGN KEY (source_program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.athlete_invites (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  athlete_id uuid NOT NULL,
  program_id uuid NOT NULL,
  email text NOT NULL,
  invite_token text NOT NULL UNIQUE,
  status text NOT NULL DEFAULT 'pending'::text,
  expires_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT athlete_invites_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_invites_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT athlete_invites_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.athlete_media (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  athlete_id uuid NOT NULL,
  media_type text NOT NULL CHECK (media_type = ANY (ARRAY['photo'::text, 'video'::text])),
  role text NOT NULL CHECK (role = ANY (ARRAY['highlight_reel'::text, 'action_shot'::text, 'gallery'::text])),
  url text NOT NULL,
  storage_bucket text,
  path text,
  sort_order integer NOT NULL DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT athlete_media_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_media_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id)
);
CREATE TABLE public.athlete_performance_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  performance_id uuid NOT NULL,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['created'::text, 'corrected'::text, 'voided'::text, 'reinstated'::text, 'source_updated'::text])),
  patch_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_by_user_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT athlete_performance_events_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_performance_events_performance_fkey FOREIGN KEY (performance_id) REFERENCES public.athlete_performances(id),
  CONSTRAINT athlete_performance_events_created_by_user_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.athlete_performance_rollups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ruleset_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  lens_code text NOT NULL,
  current_index numeric NOT NULL,
  trend_slope numeric,
  trend_confidence numeric CHECK (trend_confidence IS NULL OR trend_confidence >= 0::numeric AND trend_confidence <= 1::numeric),
  volatility_index numeric,
  computed_at timestamp with time zone NOT NULL DEFAULT now(),
  inputs_fingerprint text NOT NULL,
  CONSTRAINT athlete_performance_rollups_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_rollups_ruleset_fkey FOREIGN KEY (ruleset_id) REFERENCES public.performance_prime_rulesets(id),
  CONSTRAINT athlete_rollups_athlete_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT athlete_rollups_lens_fkey FOREIGN KEY (lens_code) REFERENCES public.performance_lenses(lens_code)
);
CREATE TABLE public.athlete_performances (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  athlete_id uuid NOT NULL,
  event_code text NOT NULL,
  mark_seconds numeric,
  mark_value numeric,
  is_personal_best boolean NOT NULL DEFAULT false,
  performance_date date,
  meet_name text,
  location text,
  performance_type text NOT NULL CHECK (performance_type = ANY (ARRAY['verified_meet'::text, 'self_reported'::text, 'training'::text])),
  timing_method text CHECK (timing_method = ANY (ARRAY['FAT'::text, 'manual'::text])),
  source_program_id uuid,
  created_by_user_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT athlete_performances_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_performances_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT athlete_performances_source_program_id_fkey FOREIGN KEY (source_program_id) REFERENCES public.programs(id),
  CONSTRAINT athlete_performances_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.athlete_scholarship_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  team_season_id uuid NOT NULL,
  roster_entry_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  changed_by_user_id uuid NOT NULL,
  old_amount numeric,
  new_amount numeric,
  old_unit text,
  new_unit text,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT athlete_scholarship_history_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_scholarship_history_team_season_id_fkey FOREIGN KEY (team_season_id) REFERENCES public.team_seasons(id),
  CONSTRAINT athlete_scholarship_history_roster_entry_id_fkey FOREIGN KEY (roster_entry_id) REFERENCES public.team_roster(id),
  CONSTRAINT athlete_scholarship_history_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT athlete_scholarship_history_changed_by_user_id_fkey FOREIGN KEY (changed_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.athlete_scores (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  athlete_id uuid NOT NULL,
  academic_score integer NOT NULL DEFAULT 0,
  performance_score integer NOT NULL DEFAULT 0,
  availability_score integer NOT NULL DEFAULT 0,
  conduct_score integer NOT NULL DEFAULT 0,
  global_overall integer NOT NULL DEFAULT 0,
  breakdown_json jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  coachable_score integer NOT NULL DEFAULT 0,
  CONSTRAINT athlete_scores_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_scores_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id)
);
CREATE TABLE public.athlete_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  stripe_customer_id text,
  stripe_subscription_id text,
  plan_code text NOT NULL,
  status text NOT NULL,
  current_period_end timestamp with time zone,
  cancel_at_period_end boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT athlete_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.athlete_training_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  athlete_id uuid NOT NULL,
  source text NOT NULL CHECK (source = ANY (ARRAY['coach_assigned'::text, 'self_assigned'::text])),
  coach_member_id uuid,
  team_season_id uuid,
  scheduled_date date,
  completed_at timestamp with time zone,
  workout_category text NOT NULL CHECK (workout_category = ANY (ARRAY['run'::text, 'gym'::text, 'cross_training'::text, 'other'::text])),
  title text,
  planned_description text,
  planned_distance_m integer,
  planned_duration_sec integer,
  planned_rpe integer CHECK (planned_rpe >= 1 AND planned_rpe <= 10),
  actual_distance_m integer,
  actual_duration_sec integer,
  actual_rpe integer CHECK (actual_rpe >= 1 AND actual_rpe <= 10),
  actual_description text,
  metrics_json jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  practice_plan_id uuid,
  practice_group_id uuid,
  workout_id uuid,
  training_event_template_id uuid,
  program_id uuid NOT NULL,
  CONSTRAINT athlete_training_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT athlete_training_sessions_practice_plan_id_fkey FOREIGN KEY (practice_plan_id) REFERENCES public.practice_plans(id),
  CONSTRAINT athlete_training_sessions_practice_group_id_fkey FOREIGN KEY (practice_group_id) REFERENCES public.practice_groups(id),
  CONSTRAINT athlete_training_sessions_workout_id_fkey FOREIGN KEY (workout_id) REFERENCES public.workouts(id),
  CONSTRAINT athlete_training_sessions_training_event_template_id_fkey FOREIGN KEY (training_event_template_id) REFERENCES public.training_event_templates(id),
  CONSTRAINT athlete_training_sessions_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT athlete_training_sessions_coach_member_id_fkey FOREIGN KEY (coach_member_id) REFERENCES public.program_members(id),
  CONSTRAINT athlete_training_sessions_team_season_id_fkey FOREIGN KEY (team_season_id) REFERENCES public.team_seasons(id),
  CONSTRAINT athlete_training_sessions_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.athletes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  organization_id uuid,
  first_name text NOT NULL,
  last_name text NOT NULL,
  grad_year integer NOT NULL,
  event_group text NOT NULL,
  user_id uuid UNIQUE,
  is_claimed boolean NOT NULL DEFAULT false,
  school_id uuid,
  hs_school_name text,
  hs_city text,
  hs_state text,
  hs_country text,
  hs_coach_name text,
  hs_coach_email text,
  hs_coach_phone text,
  avatar_url text,
  gender text CHECK (gender = ANY (ARRAY['male'::text, 'female'::text, 'coed'::text])),
  bio text,
  gpa numeric,
  test_scores jsonb,
  identity_key_weak text,
  identity_key_strong text,
  identity_confidence text NOT NULL DEFAULT 'weak'::text CHECK (identity_confidence = ANY (ARRAY['weak'::text, 'strong'::text, 'claimed'::text])),
  needs_identity_review boolean NOT NULL DEFAULT false,
  date_of_birth date,
  CONSTRAINT athletes_pkey PRIMARY KEY (id),
  CONSTRAINT athletes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT athletes_school_id_fkey FOREIGN KEY (school_id) REFERENCES public.schools(id)
);
CREATE TABLE public.audit_links (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  audit_ref text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT audit_links_pkey PRIMARY KEY (id),
  CONSTRAINT audit_links_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.authority_edges (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  from_role text NOT NULL,
  to_capability_node_id uuid NOT NULL,
  authority_type text NOT NULL DEFAULT 'standard'::text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT authority_edges_pkey PRIMARY KEY (id),
  CONSTRAINT authority_edges_to_capability_node_id_fkey FOREIGN KEY (to_capability_node_id) REFERENCES public.capability_nodes(id),
  CONSTRAINT authority_edges_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.brainstorm_index_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id uuid NOT NULL,
  index_type text NOT NULL CHECK (index_type = ANY (ARRAY['decision'::text, 'assumption'::text, 'constraint'::text, 'question'::text, 'risk'::text, 'event'::text])),
  label text NOT NULL,
  details text,
  confidence numeric CHECK (confidence IS NULL OR confidence >= 0::numeric AND confidence <= 1::numeric),
  source_message_ids ARRAY NOT NULL DEFAULT '{}'::uuid[],
  related_object_ids ARRAY NOT NULL DEFAULT '{}'::uuid[],
  created_by text NOT NULL DEFAULT 'ai'::text CHECK (created_by = ANY (ARRAY['ai'::text, 'coach'::text])),
  created_by_user_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT brainstorm_index_items_pkey PRIMARY KEY (id),
  CONSTRAINT brainstorm_index_items_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.brainstorm_sessions(id),
  CONSTRAINT brainstorm_index_items_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.brainstorm_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id uuid NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['coach'::text, 'ai'::text, 'system'::text])),
  content text NOT NULL DEFAULT ''::text,
  sequence_index bigint NOT NULL,
  refs_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_by_user_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT brainstorm_messages_pkey PRIMARY KEY (id),
  CONSTRAINT brainstorm_messages_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.brainstorm_sessions(id),
  CONSTRAINT brainstorm_messages_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.brainstorm_objects (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  page_id uuid NOT NULL,
  object_type text NOT NULL CHECK (object_type = ANY (ARRAY['text_note'::text, 'image'::text, 'file'::text, 'shape'::text, 'graph_snapshot'::text])),
  z_index integer NOT NULL DEFAULT 0,
  position_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  size_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  content_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_by_user_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT brainstorm_objects_pkey PRIMARY KEY (id),
  CONSTRAINT brainstorm_objects_page_id_fkey FOREIGN KEY (page_id) REFERENCES public.brainstorm_pages(id),
  CONSTRAINT brainstorm_objects_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.brainstorm_pages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id uuid NOT NULL,
  page_index integer NOT NULL,
  title text,
  is_archived boolean NOT NULL DEFAULT false,
  archived_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT brainstorm_pages_pkey PRIMARY KEY (id),
  CONSTRAINT brainstorm_pages_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.brainstorm_sessions(id)
);
CREATE TABLE public.brainstorm_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  scope_type text NOT NULL CHECK (scope_type = ANY (ARRAY['program'::text, 'team'::text, 'team_season'::text, 'athlete'::text, 'recruit'::text])),
  scope_id uuid,
  created_by_user_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'archived'::text])),
  started_at timestamp with time zone NOT NULL DEFAULT now(),
  ended_at timestamp with time zone,
  summary_index_json jsonb NOT NULL DEFAULT '[]'::jsonb,
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  team_id uuid,
  CONSTRAINT brainstorm_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT brainstorm_sessions_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT brainstorm_sessions_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id),
  CONSTRAINT brainstorm_sessions_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id)
);
CREATE TABLE public.canonical_event_links (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  from_canonical_event_id uuid NOT NULL,
  to_canonical_event_id uuid NOT NULL,
  link_type text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT canonical_event_links_pkey PRIMARY KEY (id),
  CONSTRAINT canonical_event_links_from_canonical_event_id_fkey FOREIGN KEY (from_canonical_event_id) REFERENCES public.canonical_events(id),
  CONSTRAINT canonical_event_links_to_canonical_event_id_fkey FOREIGN KEY (to_canonical_event_id) REFERENCES public.canonical_events(id)
);
CREATE TABLE public.canonical_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid,
  event_domain text NOT NULL,
  event_type text NOT NULL,
  scope_type text NOT NULL,
  scope_id uuid,
  actor_user_id uuid,
  source_system text NOT NULL DEFAULT 'rpc'::text,
  causality jsonb NOT NULL DEFAULT '{}'::jsonb,
  payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT canonical_events_pkey PRIMARY KEY (id),
  CONSTRAINT canonical_events_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT canonical_events_actor_user_id_fkey FOREIGN KEY (actor_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.capability_nodes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  node_code text NOT NULL,
  name text NOT NULL,
  scope_type text NOT NULL DEFAULT 'program'::text CHECK (scope_type = ANY (ARRAY['program'::text, 'team'::text])),
  description text,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  sector_key text,
  ui_slot integer DEFAULT 0,
  CONSTRAINT capability_nodes_pkey PRIMARY KEY (id),
  CONSTRAINT capability_nodes_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.capability_snapshots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  as_of_system_time timestamp with time zone NOT NULL,
  horizon text NOT NULL CHECK (horizon = ANY (ARRAY['H0'::text, 'H1'::text, 'H2'::text, 'H3'::text])),
  snapshot_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  provenance_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT capability_snapshots_pkey PRIMARY KEY (id),
  CONSTRAINT capability_snapshots_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT capability_snapshots_provenance_id_fkey FOREIGN KEY (provenance_id) REFERENCES public.provenance_meta(id)
);
CREATE TABLE public.certification_constraints (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  capability_node_id uuid NOT NULL,
  cert_type text NOT NULL,
  min_count integer NOT NULL DEFAULT 1 CHECK (min_count >= 0),
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT certification_constraints_pkey PRIMARY KEY (id),
  CONSTRAINT certification_constraints_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT certification_constraints_capability_node_id_fkey FOREIGN KEY (capability_node_id) REFERENCES public.capability_nodes(id)
);
CREATE TABLE public.coverage_requirements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  capability_node_id uuid NOT NULL,
  min_coverage integer NOT NULL DEFAULT 1 CHECK (min_coverage >= 0),
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT coverage_requirements_pkey PRIMARY KEY (id),
  CONSTRAINT coverage_requirements_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT coverage_requirements_capability_node_id_fkey FOREIGN KEY (capability_node_id) REFERENCES public.capability_nodes(id)
);
CREATE TABLE public.economic_ledger (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  canonical_event_id uuid NOT NULL UNIQUE,
  ledger_type text NOT NULL,
  amount numeric NOT NULL DEFAULT 0,
  currency text NOT NULL DEFAULT 'USD'::text,
  external_ref text,
  calculation_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'pending'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT economic_ledger_pkey PRIMARY KEY (id),
  CONSTRAINT economic_ledger_canonical_event_id_fkey FOREIGN KEY (canonical_event_id) REFERENCES public.canonical_events(id)
);
CREATE TABLE public.entitlement_ledger (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  canonical_event_id uuid NOT NULL UNIQUE,
  beneficiary_type text NOT NULL,
  beneficiary_id uuid NOT NULL,
  entitlement_type text NOT NULL,
  value_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'active'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT entitlement_ledger_pkey PRIMARY KEY (id),
  CONSTRAINT entitlement_ledger_canonical_event_id_fkey FOREIGN KEY (canonical_event_id) REFERENCES public.canonical_events(id)
);
CREATE TABLE public.event_definitions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  event_code text NOT NULL UNIQUE,
  sport text NOT NULL,
  category text NOT NULL,
  gender text,
  display_name text NOT NULL,
  measurement_unit text NOT NULL,
  is_relay boolean NOT NULL DEFAULT false,
  is_multiround boolean NOT NULL DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT event_definitions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.freeze_markers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  horizon text NOT NULL CHECK (horizon = ANY (ARRAY['H0'::text, 'H1'::text, 'H2'::text, 'H3'::text])),
  window_start timestamp with time zone NOT NULL,
  window_end timestamp with time zone NOT NULL,
  system_time timestamp with time zone NOT NULL DEFAULT now(),
  boundary_source text NOT NULL DEFAULT 'system'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT freeze_markers_pkey PRIMARY KEY (id),
  CONSTRAINT freeze_markers_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.genesis_athletes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  athlete_code text NOT NULL,
  athlete_label text NOT NULL,
  athlete_profile jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_athletes_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_athletes_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id)
);
CREATE TABLE public.genesis_audit_ledger (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  tick_index bigint NOT NULL,
  entity_type text NOT NULL,
  entity_id uuid NOT NULL,
  action_type text NOT NULL,
  action_payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_audit_ledger_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_audit_ledger_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id)
);
CREATE TABLE public.genesis_automation_executions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  law_id uuid NOT NULL,
  tick_index bigint NOT NULL,
  executed_at timestamp with time zone NOT NULL DEFAULT now(),
  result_payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  CONSTRAINT genesis_automation_executions_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_automation_executions_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id),
  CONSTRAINT genesis_automation_executions_law_id_fkey FOREIGN KEY (law_id) REFERENCES public.genesis_automation_laws(id)
);
CREATE TABLE public.genesis_automation_laws (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  law_key text NOT NULL,
  law_config jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_enabled boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_automation_laws_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_automation_laws_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id)
);
CREATE TABLE public.genesis_closure_seals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  phase text NOT NULL,
  seal_version integer NOT NULL DEFAULT 1,
  sealed_at timestamp with time zone NOT NULL DEFAULT now(),
  notes text,
  CONSTRAINT genesis_closure_seals_pkey PRIMARY KEY (id)
);
CREATE TABLE public.genesis_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  event_code text NOT NULL,
  event_label text NOT NULL,
  event_type text NOT NULL,
  event_time timestamp with time zone NOT NULL,
  event_payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_events_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_events_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id)
);
CREATE TABLE public.genesis_roster_bindings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  team_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  binding_role text NOT NULL DEFAULT 'member'::text,
  binding_meta jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_roster_bindings_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_roster_bindings_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id),
  CONSTRAINT genesis_roster_bindings_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.genesis_teams(id),
  CONSTRAINT genesis_roster_bindings_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.genesis_athletes(id)
);
CREATE TABLE public.genesis_runtime_guardians (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  plane_key text NOT NULL,
  status text NOT NULL DEFAULT 'active'::text,
  last_checked_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_runtime_guardians_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_runtime_guardians_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id)
);
CREATE TABLE public.genesis_runtime_planes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  plane_key text NOT NULL,
  plane_state jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_runtime_planes_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_runtime_planes_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id)
);
CREATE TABLE public.genesis_seasons (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  season_code text NOT NULL,
  season_label text NOT NULL,
  window_start date NOT NULL,
  window_end date NOT NULL,
  sport_phase text NOT NULL,
  default_compute_profile jsonb NOT NULL DEFAULT '{}'::jsonb,
  default_sealing_policy jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  minted_at timestamp with time zone NOT NULL DEFAULT now(),
  minted_by uuid,
  sealed_at timestamp with time zone,
  sealed_by uuid,
  closed_at timestamp with time zone,
  closed_by uuid,
  CONSTRAINT genesis_seasons_pkey PRIMARY KEY (id)
);
CREATE TABLE public.genesis_teams (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  team_code text NOT NULL,
  team_label text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_teams_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_teams_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id)
);
CREATE TABLE public.genesis_time_ticks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  season_id uuid NOT NULL,
  tick_at timestamp with time zone NOT NULL,
  tick_index bigint NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT genesis_time_ticks_pkey PRIMARY KEY (id),
  CONSTRAINT genesis_time_ticks_season_id_fkey FOREIGN KEY (season_id) REFERENCES public.genesis_seasons(id)
);
CREATE TABLE public.heat_policies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  label text NOT NULL,
  governing_body USER-DEFINED NOT NULL,
  level text,
  sport text,
  wbgt_unit text NOT NULL DEFAULT 'F'::text CHECK (wbgt_unit = ANY (ARRAY['F'::text, 'C'::text])),
  low_max numeric,
  moderate_min numeric,
  moderate_max numeric,
  high_min numeric,
  high_max numeric,
  extreme_min numeric,
  guidelines_json jsonb DEFAULT '{}'::jsonb,
  is_default boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by_user_id uuid,
  effective_year integer,
  source_primary_url text,
  source_version text,
  source_references jsonb DEFAULT '[]'::jsonb,
  verified_by_user_id uuid,
  verified_at timestamp with time zone,
  CONSTRAINT heat_policies_pkey PRIMARY KEY (id),
  CONSTRAINT heat_policies_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id),
  CONSTRAINT heat_policies_verified_by_user_id_fkey FOREIGN KEY (verified_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.horizon_fragility_vectors (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  capability_node_id uuid NOT NULL,
  h0 integer NOT NULL DEFAULT 0 CHECK (h0 >= 0),
  h1 integer NOT NULL DEFAULT 0 CHECK (h1 >= 0),
  h2 integer NOT NULL DEFAULT 0 CHECK (h2 >= 0),
  h3 integer NOT NULL DEFAULT 0 CHECK (h3 >= 0),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT horizon_fragility_vectors_pkey PRIMARY KEY (id),
  CONSTRAINT horizon_fragility_vectors_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT horizon_fragility_vectors_capability_node_id_fkey FOREIGN KEY (capability_node_id) REFERENCES public.capability_nodes(id)
);
CREATE TABLE public.lineage_edges (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  from_table text NOT NULL,
  from_id uuid NOT NULL,
  to_table text NOT NULL,
  to_id uuid NOT NULL,
  relation_type text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT lineage_edges_pkey PRIMARY KEY (id),
  CONSTRAINT lineage_edges_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.memberships (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  user_id uuid NOT NULL,
  organization_id uuid NOT NULL,
  role USER-DEFINED NOT NULL,
  CONSTRAINT memberships_pkey PRIMARY KEY (id)
);
CREATE TABLE public.operational_workflow_actions (
  key text NOT NULL,
  version text NOT NULL DEFAULT 'v1'::text,
  description text,
  schema jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_enabled boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT operational_workflow_actions_pkey PRIMARY KEY (key)
);
CREATE TABLE public.operational_workflow_invocations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  run_step_id uuid NOT NULL,
  action_key text NOT NULL,
  status text NOT NULL DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'running'::text, 'completed'::text, 'failed'::text])),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  input jsonb NOT NULL DEFAULT '{}'::jsonb,
  output jsonb NOT NULL DEFAULT '{}'::jsonb,
  error text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  idempotency_key text,
  CONSTRAINT operational_workflow_invocations_pkey PRIMARY KEY (id),
  CONSTRAINT operational_workflow_invocations_action_key_fkey FOREIGN KEY (action_key) REFERENCES public.operational_workflow_actions(key),
  CONSTRAINT operational_workflow_invocations_run_step_id_fkey FOREIGN KEY (run_step_id) REFERENCES public.operational_workflow_run_steps(id)
);
CREATE TABLE public.operational_workflow_run_step_transitions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  run_step_id uuid NOT NULL,
  from_status text,
  to_status text NOT NULL,
  message text,
  meta jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT operational_workflow_run_step_transitions_pkey PRIMARY KEY (id),
  CONSTRAINT operational_workflow_run_step_transitions_run_step_id_fkey FOREIGN KEY (run_step_id) REFERENCES public.operational_workflow_run_steps(id)
);
CREATE TABLE public.operational_workflow_run_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  run_id uuid NOT NULL,
  workflow_step_id uuid NOT NULL,
  step_order integer NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'running'::text, 'completed'::text, 'failed'::text, 'skipped'::text])),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  output jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  invocation_id uuid,
  CONSTRAINT operational_workflow_run_steps_pkey PRIMARY KEY (id),
  CONSTRAINT operational_workflow_run_steps_run_id_fkey FOREIGN KEY (run_id) REFERENCES public.operational_workflow_runs(id),
  CONSTRAINT operational_workflow_run_steps_workflow_step_id_fkey FOREIGN KEY (workflow_step_id) REFERENCES public.operational_workflow_steps(id)
);
CREATE TABLE public.operational_workflow_runs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_id uuid NOT NULL,
  program_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'running'::text, 'completed'::text, 'failed'::text])),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  result jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  idempotency_key text,
  CONSTRAINT operational_workflow_runs_pkey PRIMARY KEY (id),
  CONSTRAINT operational_workflow_runs_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.operational_workflows(id)
);
CREATE TABLE public.operational_workflow_schedule_firings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  schedule_id uuid NOT NULL,
  program_id uuid NOT NULL,
  workflow_id uuid NOT NULL,
  due_at timestamp with time zone NOT NULL,
  status text NOT NULL DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'started'::text, 'completed'::text, 'failed'::text])),
  run_id uuid,
  error text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT operational_workflow_schedule_firings_pkey PRIMARY KEY (id),
  CONSTRAINT operational_workflow_schedule_firings_schedule_id_fkey FOREIGN KEY (schedule_id) REFERENCES public.operational_workflow_schedules(id),
  CONSTRAINT operational_workflow_schedule_firings_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.operational_workflows(id),
  CONSTRAINT operational_workflow_schedule_firings_run_id_fkey FOREIGN KEY (run_id) REFERENCES public.operational_workflow_runs(id)
);
CREATE TABLE public.operational_workflow_schedule_ticks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  schedule_id uuid NOT NULL,
  ticked_at timestamp with time zone NOT NULL DEFAULT now(),
  due_at timestamp with time zone,
  meta jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT operational_workflow_schedule_ticks_pkey PRIMARY KEY (id),
  CONSTRAINT operational_workflow_schedule_ticks_schedule_id_fkey FOREIGN KEY (schedule_id) REFERENCES public.operational_workflow_schedules(id)
);
CREATE TABLE public.operational_workflow_schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  workflow_id uuid NOT NULL,
  name text NOT NULL,
  cron text NOT NULL,
  timezone text NOT NULL DEFAULT 'UTC'::text,
  is_enabled boolean NOT NULL DEFAULT true,
  spec jsonb NOT NULL DEFAULT '{}'::jsonb,
  last_run_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT operational_workflow_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT operational_workflow_schedules_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.operational_workflows(id)
);
CREATE TABLE public.operational_workflow_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_id uuid NOT NULL,
  step_order integer NOT NULL,
  action text NOT NULL,
  config jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  action_key text NOT NULL,
  CONSTRAINT operational_workflow_steps_pkey PRIMARY KEY (id),
  CONSTRAINT operational_workflow_steps_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.operational_workflows(id),
  CONSTRAINT operational_workflow_steps_action_key_fk FOREIGN KEY (action_key) REFERENCES public.operational_workflow_actions(key)
);
CREATE TABLE public.operational_workflow_violation_registry (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  entity_type text NOT NULL,
  entity_id uuid NOT NULL,
  violation_type text NOT NULL,
  severity text NOT NULL CHECK (severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  status text NOT NULL DEFAULT 'open'::text,
  detected_at timestamp with time zone NOT NULL DEFAULT now(),
  resolved_at timestamp with time zone,
  CONSTRAINT operational_workflow_violation_registry_pkey PRIMARY KEY (id)
);
CREATE TABLE public.operational_workflows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  name text NOT NULL,
  spec jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'paused'::text, 'archived'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT operational_workflows_pkey PRIMARY KEY (id)
);
CREATE TABLE public.performance_balance_snapshots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  team_id uuid,
  team_season_id uuid,
  lens_code text NOT NULL,
  window_start_date date,
  window_end_date date,
  pairs_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  aggregate_percentile numeric,
  is_out_of_equilibrium boolean NOT NULL DEFAULT false,
  rollup_ruleset_code text,
  prime_ruleset_code text,
  computed_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_balance_snapshots_pkey PRIMARY KEY (id),
  CONSTRAINT performance_balance_snapshots_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT performance_balance_snapshots_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id),
  CONSTRAINT performance_balance_snapshots_team_season_id_fkey FOREIGN KEY (team_season_id) REFERENCES public.team_seasons(id),
  CONSTRAINT performance_balance_snapshots_lens_code_fkey FOREIGN KEY (lens_code) REFERENCES public.performance_lenses(lens_code)
);
CREATE TABLE public.performance_compute_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  scope_type text NOT NULL CHECK (scope_type = ANY (ARRAY['program'::text, 'athlete'::text, 'team_season'::text, 'team'::text, 'global'::text])),
  scope_id uuid,
  reason text NOT NULL CHECK (reason = ANY (ARRAY['raw_insert'::text, 'raw_corrected'::text, 'raw_voided'::text, 'roster_changed'::text, 'ruleset_changed'::text, 'lens_changed'::text, 'season_boundary'::text, 'manual_recompute'::text])),
  details_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'processing'::text, 'done'::text, 'failed'::text, 'canceled'::text])),
  attempts integer NOT NULL DEFAULT 0 CHECK (attempts >= 0),
  not_before timestamp with time zone,
  locked_at timestamp with time zone,
  locked_by text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_compute_queue_pkey PRIMARY KEY (id)
);
CREATE TABLE public.performance_compute_runs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  queue_id uuid,
  scope_type text NOT NULL CHECK (scope_type = ANY (ARRAY['program'::text, 'athlete'::text, 'team_season'::text, 'team'::text, 'global'::text])),
  scope_id uuid,
  stages jsonb NOT NULL DEFAULT '[]'::jsonb,
  prime_ruleset_code text,
  signal_ruleset_code text,
  lens_codes ARRAY DEFAULT '{}'::text[],
  started_at timestamp with time zone NOT NULL DEFAULT now(),
  finished_at timestamp with time zone,
  status text NOT NULL DEFAULT 'running'::text CHECK (status = ANY (ARRAY['running'::text, 'succeeded'::text, 'failed'::text, 'partial'::text])),
  summary_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  error_json jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_compute_runs_pkey PRIMARY KEY (id),
  CONSTRAINT performance_compute_runs_queue_fkey FOREIGN KEY (queue_id) REFERENCES public.performance_compute_queue(id)
);
CREATE TABLE public.performance_lenses (
  lens_code text NOT NULL,
  subject_type text NOT NULL CHECK (subject_type = ANY (ARRAY['athlete'::text, 'team_season'::text, 'team_window'::text])),
  definition_json jsonb NOT NULL,
  display_label text,
  is_default boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by_user_id uuid,
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_lenses_pkey PRIMARY KEY (lens_code),
  CONSTRAINT performance_lenses_created_by_user_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.performance_prime_rulesets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ruleset_code text NOT NULL UNIQUE,
  formula_spec_json jsonb NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_prime_rulesets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.performance_primes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ruleset_id uuid NOT NULL,
  performance_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  event_code text NOT NULL,
  canonical_event_code text NOT NULL,
  canonical_mark_seconds numeric,
  canonical_mark_value numeric,
  normalized_index numeric NOT NULL,
  inputs_fingerprint text NOT NULL,
  computed_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_primes_pkey PRIMARY KEY (id),
  CONSTRAINT performance_primes_ruleset_fkey FOREIGN KEY (ruleset_id) REFERENCES public.performance_prime_rulesets(id),
  CONSTRAINT performance_primes_performance_fkey FOREIGN KEY (performance_id) REFERENCES public.athlete_performances(id),
  CONSTRAINT performance_primes_athlete_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id)
);
CREATE TABLE public.performance_reference_sets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  set_code text NOT NULL UNIQUE,
  label text NOT NULL,
  academic_year text,
  source_meta jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_reference_sets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.performance_reference_standards (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  set_id uuid NOT NULL,
  event_code text NOT NULL,
  gender text,
  level text,
  reference_mark_seconds numeric,
  reference_mark_value numeric,
  measurement_unit text,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_reference_standards_pkey PRIMARY KEY (id),
  CONSTRAINT performance_reference_standards_set_fkey FOREIGN KEY (set_id) REFERENCES public.performance_reference_sets(id)
);
CREATE TABLE public.performance_signal_rulesets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ruleset_code text NOT NULL UNIQUE,
  rules_json jsonb NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_signal_rulesets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.performance_signals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ruleset_id uuid NOT NULL,
  subject_type text NOT NULL CHECK (subject_type = ANY (ARRAY['athlete'::text, 'team_season'::text, 'team_window'::text])),
  subject_id uuid NOT NULL,
  lens_code text NOT NULL,
  signal_code text NOT NULL,
  severity integer NOT NULL DEFAULT 1 CHECK (severity >= 1 AND severity <= 5),
  evidence_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  runtime_id uuid NOT NULL DEFAULT '5a9b2fbd-118d-4a1b-a36d-dbb354f0ea98'::uuid,
  CONSTRAINT performance_signals_pkey PRIMARY KEY (id),
  CONSTRAINT performance_signals_ruleset_fkey FOREIGN KEY (ruleset_id) REFERENCES public.performance_signal_rulesets(id),
  CONSTRAINT performance_signals_lens_fkey FOREIGN KEY (lens_code) REFERENCES public.performance_lenses(lens_code)
);
CREATE TABLE public.practice_group_assignments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  practice_group_id uuid NOT NULL,
  team_roster_id uuid,
  athlete_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT practice_group_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT practice_group_assignments_practice_group_id_fkey FOREIGN KEY (practice_group_id) REFERENCES public.practice_groups(id),
  CONSTRAINT practice_group_assignments_team_roster_id_fkey FOREIGN KEY (team_roster_id) REFERENCES public.team_roster(id),
  CONSTRAINT practice_group_assignments_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id)
);
CREATE TABLE public.practice_groups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  practice_plan_id uuid NOT NULL,
  label text NOT NULL,
  event_group text,
  workout_id uuid NOT NULL,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT practice_groups_pkey PRIMARY KEY (id),
  CONSTRAINT practice_groups_practice_plan_id_fkey FOREIGN KEY (practice_plan_id) REFERENCES public.practice_plans(id),
  CONSTRAINT practice_groups_workout_id_fkey FOREIGN KEY (workout_id) REFERENCES public.workouts(id)
);
CREATE TABLE public.practice_plans (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  team_season_id uuid,
  practice_date date NOT NULL,
  start_time timestamp with time zone,
  location text,
  label text NOT NULL,
  notes text,
  status text NOT NULL DEFAULT 'planned'::text CHECK (status = ANY (ARRAY['planned'::text, 'published'::text, 'completed'::text, 'canceled'::text])),
  created_by_program_member_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  end_time timestamp with time zone,
  weather_snapshot jsonb,
  wbgt_f numeric,
  wbgt_c numeric,
  heat_risk USER-DEFINED,
  CONSTRAINT practice_plans_pkey PRIMARY KEY (id),
  CONSTRAINT practice_plans_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT practice_plans_team_season_id_fkey FOREIGN KEY (team_season_id) REFERENCES public.team_seasons(id),
  CONSTRAINT practice_plans_created_by_program_member_id_fkey FOREIGN KEY (created_by_program_member_id) REFERENCES public.program_members(id)
);
CREATE TABLE public.practice_weather_snapshots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  practice_plan_id uuid NOT NULL,
  captured_at timestamp with time zone NOT NULL DEFAULT now(),
  source text NOT NULL CHECK (source = ANY (ARRAY['tomorrow_io'::text, 'manual'::text])),
  location_text text,
  location_lat numeric,
  location_lon numeric,
  wbgt_f numeric,
  wbgt_c numeric,
  temp_f numeric,
  temp_c numeric,
  humidity_percent numeric,
  wind_mph numeric,
  wind_kph numeric,
  weather_code integer,
  weather_summary text,
  heat_risk USER-DEFINED,
  governing_body USER-DEFINED,
  heat_policy_id uuid,
  conditions_json jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT practice_weather_snapshots_pkey PRIMARY KEY (id),
  CONSTRAINT practice_weather_snapshots_heat_policy_id_fkey FOREIGN KEY (heat_policy_id) REFERENCES public.heat_policies(id),
  CONSTRAINT practice_weather_snapshots_practice_plan_id_fkey FOREIGN KEY (practice_plan_id) REFERENCES public.practice_plans(id)
);
CREATE TABLE public.program_athlete_notes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  body text NOT NULL DEFAULT ''::text,
  created_by_user_id uuid NOT NULL,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_athlete_notes_pkey PRIMARY KEY (id),
  CONSTRAINT program_athlete_notes_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_athlete_notes_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT program_athlete_notes_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.program_athlete_scores (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  scoring_profile_id uuid,
  overall_for_program integer NOT NULL DEFAULT 0,
  fit_score_for_program integer,
  breakdown_json jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_athlete_scores_pkey PRIMARY KEY (id),
  CONSTRAINT program_athlete_scores_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_athlete_scores_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT program_athlete_scores_scoring_profile_id_fkey FOREIGN KEY (scoring_profile_id) REFERENCES public.program_scoring_profiles(id)
);
CREATE TABLE public.program_athletes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  program_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  level text,
  relationship_type text NOT NULL DEFAULT 'recruit'::text,
  status text,
  source text,
  created_by_program_member_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  archived_at timestamp with time zone,
  CONSTRAINT program_athletes_pkey PRIMARY KEY (id),
  CONSTRAINT program_athletes_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_athletes_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT program_athletes_created_by_program_member_id_fkey FOREIGN KEY (created_by_program_member_id) REFERENCES public.program_members(id)
);
CREATE TABLE public.program_authority_assignments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  program_member_id uuid NOT NULL,
  authority_type text NOT NULL DEFAULT 'standard'::text,
  is_active boolean NOT NULL DEFAULT true,
  effective_start_date date,
  effective_end_date date,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_authority_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT program_authority_assignments_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_authority_assignments_program_member_id_fkey FOREIGN KEY (program_member_id) REFERENCES public.program_members(id)
);
CREATE TABLE public.program_branding (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL UNIQUE,
  primary_color text,
  secondary_color text,
  accent_color text,
  background_color text,
  surface_color text,
  foreground_color text,
  muted_foreground_color text,
  success_color text,
  warning_color text,
  danger_color text,
  link_color text,
  logo_url text,
  wordmark_url text,
  mascot_name text,
  theme_mode text CHECK (theme_mode = ANY (ARRAY['light'::text, 'dark'::text, 'system'::text])),
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_branding_pkey PRIMARY KEY (id),
  CONSTRAINT program_branding_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.program_capability_assignments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  program_member_id uuid NOT NULL,
  capability_node_id uuid NOT NULL,
  coverage_type text NOT NULL DEFAULT 'secondary'::text CHECK (coverage_type = ANY (ARRAY['primary'::text, 'secondary'::text])),
  is_active boolean NOT NULL DEFAULT true,
  effective_start_date date,
  effective_end_date date,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_capability_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT program_capability_assignments_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_capability_assignments_program_member_id_fkey FOREIGN KEY (program_member_id) REFERENCES public.program_members(id),
  CONSTRAINT program_capability_assignments_capability_node_id_fkey FOREIGN KEY (capability_node_id) REFERENCES public.capability_nodes(id)
);
CREATE TABLE public.program_health_absences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  scope_id uuid,
  sport text NOT NULL CHECK (sport = ANY (ARRAY['xc'::text, 'tf'::text])),
  horizon text NOT NULL CHECK (horizon = ANY (ARRAY['H0'::text, 'H1'::text, 'H2'::text, 'H3'::text])),
  absence_key text NOT NULL,
  absence_type text NOT NULL,
  severity text,
  details jsonb NOT NULL DEFAULT '{}'::jsonb,
  canonical_event_id uuid NOT NULL,
  ledger_id uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  capability_node_id uuid,
  cause_event_id uuid,
  notes text,
  CONSTRAINT program_health_absences_pkey PRIMARY KEY (id)
);
CREATE TABLE public.program_health_compute_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  reason text NOT NULL DEFAULT 'manual_recompute'::text,
  details_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'processing'::text, 'done'::text, 'failed'::text, 'canceled'::text])),
  attempts integer NOT NULL DEFAULT 0 CHECK (attempts >= 0),
  not_before timestamp with time zone,
  locked_at timestamp with time zone,
  locked_by text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_health_compute_queue_pkey PRIMARY KEY (id),
  CONSTRAINT program_health_compute_queue_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.program_health_compute_runs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  queue_id uuid,
  program_id uuid NOT NULL,
  stages jsonb NOT NULL DEFAULT '[]'::jsonb,
  started_at timestamp with time zone NOT NULL DEFAULT now(),
  finished_at timestamp with time zone,
  status text NOT NULL DEFAULT 'running'::text CHECK (status = ANY (ARRAY['running'::text, 'succeeded'::text, 'failed'::text, 'partial'::text])),
  summary_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  error_json jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_health_compute_runs_pkey PRIMARY KEY (id),
  CONSTRAINT program_health_compute_runs_queue_id_fkey FOREIGN KEY (queue_id) REFERENCES public.program_health_compute_queue(id),
  CONSTRAINT program_health_compute_runs_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.program_health_ledger (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  canonical_event_id uuid NOT NULL,
  program_id uuid NOT NULL,
  engine_version text NOT NULL DEFAULT 'a1_v1'::text,
  sport text NOT NULL CHECK (sport = ANY (ARRAY['xc'::text, 'tf'::text])),
  horizon text NOT NULL CHECK (horizon = ANY (ARRAY['H0'::text, 'H1'::text, 'H2'::text, 'H3'::text])),
  inputs_hash text NOT NULL,
  result_payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_health_ledger_pkey PRIMARY KEY (id)
);
CREATE TABLE public.program_health_snapshots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  scope_id uuid,
  sport text NOT NULL CHECK (sport = ANY (ARRAY['xc'::text, 'tf'::text])),
  horizon text NOT NULL CHECK (horizon = ANY (ARRAY['H0'::text, 'H1'::text, 'H2'::text, 'H3'::text])),
  canonical_event_id uuid NOT NULL,
  ledger_id uuid NOT NULL,
  inputs_hash text NOT NULL,
  summary jsonb NOT NULL DEFAULT '{}'::jsonb,
  full_payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_health_snapshots_pkey PRIMARY KEY (id)
);
CREATE TABLE public.program_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text NOT NULL DEFAULT 'member'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_members_pkey PRIMARY KEY (id),
  CONSTRAINT program_members_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.program_recruits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  recruiting_profile_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'evaluating'::text,
  source text NOT NULL DEFAULT 'coach_manual'::text,
  interest_level integer,
  primary_coach_member_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  athlete_id uuid,
  recruiting_score numeric,
  recruit_id uuid CHECK (recruit_id IS NOT NULL),
  CONSTRAINT program_recruits_pkey PRIMARY KEY (id),
  CONSTRAINT program_recruits_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_recruits_recruiting_profile_id_fkey FOREIGN KEY (recruiting_profile_id) REFERENCES public.recruiting_profiles(id),
  CONSTRAINT program_recruits_primary_coach_member_id_fkey FOREIGN KEY (primary_coach_member_id) REFERENCES public.program_members(id),
  CONSTRAINT program_recruits_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT program_recruits_recruit_id_fkey FOREIGN KEY (recruit_id) REFERENCES public.recruits(id)
);
CREATE TABLE public.program_scoring_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  label text NOT NULL,
  weights_json jsonb NOT NULL,
  is_default boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_scoring_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT program_scoring_profiles_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.program_staff_certifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  program_member_id uuid NOT NULL,
  cert_type text NOT NULL,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'expired'::text, 'revoked'::text, 'pending'::text])),
  issued_at date,
  expires_at date,
  evidence_url text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_staff_certifications_pkey PRIMARY KEY (id),
  CONSTRAINT program_staff_certifications_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_staff_certifications_program_member_id_fkey FOREIGN KEY (program_member_id) REFERENCES public.program_members(id)
);
CREATE TABLE public.program_staff_roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  program_member_id uuid NOT NULL,
  role_code text NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  effective_start_date date,
  effective_end_date date,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_staff_roles_pkey PRIMARY KEY (id),
  CONSTRAINT program_staff_roles_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT program_staff_roles_program_member_id_fkey FOREIGN KEY (program_member_id) REFERENCES public.program_members(id)
);
CREATE TABLE public.program_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL UNIQUE,
  stripe_customer_id text,
  stripe_subscription_id text UNIQUE,
  plan_code text NOT NULL,
  status text NOT NULL,
  current_period_end timestamp with time zone,
  cancel_at_period_end boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT program_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT program_subscriptions_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.programs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  school_id uuid NOT NULL,
  name text NOT NULL,
  sport text NOT NULL,
  gender text,
  level text,
  season text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT programs_pkey PRIMARY KEY (id),
  CONSTRAINT programs_school_id_fkey FOREIGN KEY (school_id) REFERENCES public.schools(id)
);
CREATE TABLE public.provenance_meta (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  engine_code text NOT NULL,
  run_id uuid,
  source text NOT NULL DEFAULT 'program_health_engine'::text,
  system_time timestamp with time zone NOT NULL DEFAULT now(),
  mutation_state text NOT NULL DEFAULT 'pre_freeze'::text CHECK (mutation_state = ANY (ARRAY['pre_freeze'::text, 'frozen'::text])),
  meta_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT provenance_meta_pkey PRIMARY KEY (id),
  CONSTRAINT provenance_meta_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.recruiting_candidate_impacts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  recruit_id uuid NOT NULL,
  sport text NOT NULL CHECK (sport = ANY (ARRAY['xc'::text, 'tf'::text])),
  horizon text NOT NULL CHECK (horizon = ANY (ARRAY['H0'::text, 'H1'::text, 'H2'::text, 'H3'::text])),
  capability_node_id uuid NOT NULL,
  impact_score numeric NOT NULL CHECK (impact_score >= 0::numeric),
  cohort_tier integer NOT NULL CHECK (cohort_tier >= 0 AND cohort_tier <= 3),
  rationale jsonb NOT NULL DEFAULT '{}'::jsonb,
  inputs_hash text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  canonical_event_id uuid,
  CONSTRAINT recruiting_candidate_impacts_pkey PRIMARY KEY (id)
);
CREATE TABLE public.recruiting_ledger (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  canonical_event_id uuid NOT NULL,
  program_id uuid NOT NULL,
  recruit_id uuid NOT NULL,
  upstream_a1_canonical_event_id uuid NOT NULL,
  inputs_hash text NOT NULL,
  result_payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT recruiting_ledger_pkey PRIMARY KEY (id),
  CONSTRAINT recruiting_ledger_canonical_event_id_fkey FOREIGN KEY (canonical_event_id) REFERENCES public.canonical_events(id),
  CONSTRAINT recruiting_ledger_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT recruiting_ledger_upstream_a1_canonical_event_id_fkey FOREIGN KEY (upstream_a1_canonical_event_id) REFERENCES public.canonical_events(id),
  CONSTRAINT recruiting_ledger_recruit_id_fkey FOREIGN KEY (recruit_id) REFERENCES public.recruits(id)
);
CREATE TABLE public.recruiting_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  athlete_id uuid NOT NULL,
  profile_type text NOT NULL DEFAULT 'hs'::text,
  hs_school_id uuid,
  current_program_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT recruiting_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT recruiting_profiles_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT recruiting_profiles_hs_school_id_fkey FOREIGN KEY (hs_school_id) REFERENCES public.schools(id),
  CONSTRAINT recruiting_profiles_current_program_id_fkey FOREIGN KEY (current_program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.recruiting_snapshots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  canonical_event_id uuid NOT NULL,
  program_id uuid NOT NULL,
  recruit_id uuid NOT NULL,
  horizon text NOT NULL,
  recruiting_score numeric NOT NULL,
  ai_confidence numeric NOT NULL,
  a1_canonical_event_id uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  retained_until timestamp with time zone,
  CONSTRAINT recruiting_snapshots_pkey PRIMARY KEY (id)
);
CREATE TABLE public.recruiting_state_signals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  sport text NOT NULL CHECK (sport = ANY (ARRAY['xc'::text, 'tf'::text])),
  horizon text NOT NULL CHECK (horizon = ANY (ARRAY['H0'::text, 'H1'::text, 'H2'::text, 'H3'::text])),
  signal_type text NOT NULL CHECK (signal_type = ANY (ARRAY['within_tolerance'::text, 'approaching_boundary'::text, 'outside_tolerance'::text])),
  context jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by_event_id uuid,
  CONSTRAINT recruiting_state_signals_pkey PRIMARY KEY (id)
);
CREATE TABLE public.recruits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  organization_id uuid NOT NULL,
  first_name text NOT NULL,
  last_name text NOT NULL,
  grad_year integer NOT NULL,
  event_group text NOT NULL,
  status text NOT NULL,
  notes text,
  pipeline_stage text DEFAULT ''::text CHECK (pipeline_stage = ANY (ARRAY['new'::text, 'evaluating'::text, 'priority'::text, 'offer_out'::text, 'committed'::text, 'archived'::text])),
  interest_level integer DEFAULT 3 CHECK (interest_level >= 1 AND interest_level <= 5),
  probability numeric DEFAULT 0.25 CHECK (probability >= 0::numeric AND probability <= 1::numeric),
  projected_points numeric,
  last_contact_at timestamp with time zone,
  next_action_at timestamp with time zone,
  color_tag text,
  recruiting_score numeric,
  is_placeholder boolean NOT NULL DEFAULT false,
  CONSTRAINT recruits_pkey PRIMARY KEY (id)
);
CREATE TABLE public.redundancy_depths (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  capability_node_id uuid NOT NULL,
  min_depth integer NOT NULL DEFAULT 0 CHECK (min_depth >= 0),
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT redundancy_depths_pkey PRIMARY KEY (id),
  CONSTRAINT redundancy_depths_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT redundancy_depths_capability_node_id_fkey FOREIGN KEY (capability_node_id) REFERENCES public.capability_nodes(id)
);
CREATE TABLE public.roster_athletes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recruit_id uuid,
  first_name text NOT NULL,
  last_name text NOT NULL,
  sex text CHECK (sex = ANY (ARRAY['male'::text, 'female'::text, 'other'::text])),
  grad_year integer,
  position_group text,
  primary_event text,
  pr_seconds numeric,
  class_year text,
  scholarship_pct numeric,
  is_active boolean NOT NULL DEFAULT true,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT roster_athletes_pkey PRIMARY KEY (id),
  CONSTRAINT roster_athletes_recruit_id_fkey FOREIGN KEY (recruit_id) REFERENCES public.recruits(id)
);
CREATE TABLE public.roster_scenario_entries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  scenario_id uuid NOT NULL,
  athlete_id uuid,
  program_recruit_id uuid,
  projected_role text,
  projected_status text,
  projected_class_year integer,
  event_group text,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  scholarship_amount numeric,
  scholarship_unit text DEFAULT 'percent'::text CHECK (scholarship_unit = ANY (ARRAY['percent'::text, 'amount'::text])),
  scholarship_notes text,
  CONSTRAINT roster_scenario_entries_pkey PRIMARY KEY (id),
  CONSTRAINT roster_scenario_entries_scenario_id_fkey FOREIGN KEY (scenario_id) REFERENCES public.roster_scenarios(id),
  CONSTRAINT roster_scenario_entries_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT roster_scenario_entries_program_recruit_id_fkey FOREIGN KEY (program_recruit_id) REFERENCES public.program_recruits(id)
);
CREATE TABLE public.roster_scenarios (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  team_id uuid NOT NULL,
  name text NOT NULL,
  target_season_label text,
  target_season_year integer,
  notes text,
  created_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'candidate'::text, 'active'::text])),
  CONSTRAINT roster_scenarios_pkey PRIMARY KEY (id),
  CONSTRAINT roster_scenarios_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT roster_scenarios_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id),
  CONSTRAINT roster_scenarios_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.runtime_authority_surfaces (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  runtime_id uuid NOT NULL,
  authority_class text NOT NULL,
  principal_id uuid NOT NULL,
  scope jsonb NOT NULL DEFAULT '{}'::jsonb,
  permissions jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'suspended'::text, 'revoked'::text])),
  installed_by_event_id uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT runtime_authority_surfaces_pkey PRIMARY KEY (id),
  CONSTRAINT runtime_authority_surfaces_runtime_id_fkey FOREIGN KEY (runtime_id) REFERENCES public.runtimes(id),
  CONSTRAINT runtime_authority_surfaces_installed_by_event_id_fkey FOREIGN KEY (installed_by_event_id) REFERENCES public.runtime_events(event_id)
);
CREATE TABLE public.runtime_charters (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  parent_runtime_id uuid NOT NULL,
  runtime_type text NOT NULL,
  temporal_scope jsonb NOT NULL DEFAULT '{}'::jsonb,
  identity_seeds jsonb NOT NULL DEFAULT '{}'::jsonb,
  requested_authorities jsonb NOT NULL DEFAULT '{}'::jsonb,
  submitted_by_actor_type text NOT NULL,
  submitted_by_actor_id uuid NOT NULL,
  submitted_at timestamp with time zone NOT NULL DEFAULT now(),
  status USER-DEFINED NOT NULL DEFAULT 'submitted'::runtime_charter_status,
  decision_event_id uuid,
  CONSTRAINT runtime_charters_pkey PRIMARY KEY (id),
  CONSTRAINT runtime_charters_parent_runtime_id_fkey FOREIGN KEY (parent_runtime_id) REFERENCES public.runtimes(id),
  CONSTRAINT runtime_charters_decision_event_id_fkey FOREIGN KEY (decision_event_id) REFERENCES public.runtime_events(event_id)
);
CREATE TABLE public.runtime_events (
  event_id uuid NOT NULL DEFAULT gen_random_uuid(),
  runtime_id uuid NOT NULL,
  parent_runtime_id uuid,
  cause_event_id uuid,
  occurred_at timestamp with time zone NOT NULL,
  recorded_at timestamp with time zone NOT NULL DEFAULT now(),
  actor_type text NOT NULL,
  actor_id uuid NOT NULL,
  scope_type USER-DEFINED NOT NULL,
  scope_id uuid NOT NULL,
  event_type text NOT NULL,
  payload jsonb NOT NULL DEFAULT '{}'::jsonb,
  prev_hash text,
  hash text NOT NULL,
  CONSTRAINT runtime_events_pkey PRIMARY KEY (event_id),
  CONSTRAINT runtime_events_runtime_id_fkey FOREIGN KEY (runtime_id) REFERENCES public.runtimes(id),
  CONSTRAINT runtime_events_parent_runtime_id_fkey FOREIGN KEY (parent_runtime_id) REFERENCES public.runtimes(id),
  CONSTRAINT runtime_events_cause_event_id_fkey FOREIGN KEY (cause_event_id) REFERENCES public.runtime_events(event_id)
);
CREATE TABLE public.runtime_partitions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  runtime_id uuid NOT NULL,
  partition_type USER-DEFINED NOT NULL,
  partition_key text NOT NULL,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'retired'::text])),
  installed_by_event_id uuid NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT runtime_partitions_pkey PRIMARY KEY (id),
  CONSTRAINT runtime_partitions_runtime_id_fkey FOREIGN KEY (runtime_id) REFERENCES public.runtimes(id),
  CONSTRAINT runtime_partitions_installed_by_event_id_fkey FOREIGN KEY (installed_by_event_id) REFERENCES public.runtime_events(event_id)
);
CREATE TABLE public.runtimes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  runtime_type text NOT NULL,
  parent_runtime_id uuid,
  status USER-DEFINED NOT NULL DEFAULT 'forging'::runtime_status,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  sealed_at timestamp with time zone,
  closed_at timestamp with time zone,
  temporal_origin timestamp with time zone NOT NULL DEFAULT now(),
  temporal_scope jsonb NOT NULL DEFAULT '{}'::jsonb,
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  CONSTRAINT runtimes_pkey PRIMARY KEY (id),
  CONSTRAINT runtimes_parent_runtime_id_fkey FOREIGN KEY (parent_runtime_id) REFERENCES public.runtimes(id)
);
CREATE TABLE public.schools (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  level text NOT NULL,
  country text,
  state text,
  city text,
  postal_code text,
  short_code text,
  external_ref text,
  is_claimed boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  primary_color text,
  secondary_color text,
  logo_url text,
  domain text,
  identity_json jsonb,
  latitude numeric,
  longitude numeric,
  timezone text,
  CONSTRAINT schools_pkey PRIMARY KEY (id)
);
CREATE TABLE public.season_budget_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  team_season_id uuid NOT NULL,
  changed_by_user_id uuid NOT NULL,
  old_scholarship_budget_equivalents numeric,
  new_scholarship_budget_equivalents numeric,
  old_scholarship_budget_amount numeric,
  new_scholarship_budget_amount numeric,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT season_budget_history_pkey PRIMARY KEY (id),
  CONSTRAINT season_budget_history_team_season_id_fkey FOREIGN KEY (team_season_id) REFERENCES public.team_seasons(id),
  CONSTRAINT season_budget_history_changed_by_user_id_fkey FOREIGN KEY (changed_by_user_id) REFERENCES public.users(id)
);
CREATE TABLE public.team_performance_rollups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ruleset_id uuid NOT NULL,
  program_id uuid NOT NULL,
  team_id uuid NOT NULL,
  team_season_id uuid,
  subject_type text NOT NULL CHECK (subject_type = ANY (ARRAY['team_season'::text, 'team_window'::text])),
  subject_id uuid NOT NULL,
  lens_code text NOT NULL,
  scoring_capacity_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  coverage_depth_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  team_trajectory_index numeric,
  team_volatility_index numeric,
  computed_at timestamp with time zone NOT NULL DEFAULT now(),
  inputs_fingerprint text NOT NULL,
  CONSTRAINT team_performance_rollups_pkey PRIMARY KEY (id),
  CONSTRAINT team_rollups_ruleset_fkey FOREIGN KEY (ruleset_id) REFERENCES public.performance_prime_rulesets(id),
  CONSTRAINT team_rollups_program_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT team_rollups_team_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id),
  CONSTRAINT team_rollups_team_season_fkey FOREIGN KEY (team_season_id) REFERENCES public.team_seasons(id),
  CONSTRAINT team_rollups_lens_fkey FOREIGN KEY (lens_code) REFERENCES public.performance_lenses(lens_code)
);
CREATE TABLE public.team_roster (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  program_id uuid NOT NULL,
  team_id uuid NOT NULL,
  team_season_id uuid NOT NULL,
  athlete_id uuid NOT NULL,
  jersey_number text,
  role text,
  status text,
  depth_order integer,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  program_recruit_id uuid,
  scholarship_amount numeric,
  scholarship_unit text DEFAULT 'percent'::text CHECK (scholarship_unit = ANY (ARRAY['percent'::text, 'equivalency'::text, 'amount'::text])),
  scholarship_notes text,
  event_group text,
  CONSTRAINT team_roster_pkey PRIMARY KEY (id),
  CONSTRAINT team_roster_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT team_roster_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id),
  CONSTRAINT team_roster_team_season_id_fkey FOREIGN KEY (team_season_id) REFERENCES public.team_seasons(id),
  CONSTRAINT team_roster_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT team_roster_program_recruit_id_fkey FOREIGN KEY (program_recruit_id) REFERENCES public.program_recruits(id)
);
CREATE TABLE public.team_roster_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  team_roster_id uuid NOT NULL,
  event_code text NOT NULL,
  is_primary boolean NOT NULL DEFAULT false,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT team_roster_events_pkey PRIMARY KEY (id),
  CONSTRAINT team_roster_events_team_roster_id_fkey FOREIGN KEY (team_roster_id) REFERENCES public.team_roster(id)
);
CREATE TABLE public.team_seasons (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  team_id uuid NOT NULL,
  program_id uuid NOT NULL,
  academic_year text NOT NULL,
  year_start integer NOT NULL,
  year_end integer,
  season_label text NOT NULL,
  is_current boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  season_year integer,
  start_date date,
  end_date date,
  is_active boolean NOT NULL DEFAULT true,
  roster_lock_date timestamp with time zone,
  scholarship_budget_equivalents numeric,
  scholarship_budget_amount numeric,
  scholarship_currency text DEFAULT 'USD'::text,
  is_locked boolean DEFAULT false,
  event_group_quotas jsonb DEFAULT '{}'::jsonb,
  governing_body USER-DEFINED,
  heat_policy_id uuid,
  CONSTRAINT team_seasons_pkey PRIMARY KEY (id),
  CONSTRAINT team_seasons_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id),
  CONSTRAINT team_seasons_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT team_seasons_heat_policy_id_fkey FOREIGN KEY (heat_policy_id) REFERENCES public.heat_policies(id)
);
CREATE TABLE public.teams (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  program_id uuid NOT NULL,
  name text NOT NULL,
  code text,
  sport text,
  gender text,
  level text,
  season text,
  is_primary boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  scholarship_budget numeric,
  scholarship_unit text,
  CONSTRAINT teams_pkey PRIMARY KEY (id),
  CONSTRAINT teams_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id)
);
CREATE TABLE public.training_event_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid,
  event_code text,
  label text NOT NULL,
  description text,
  default_parameters jsonb DEFAULT '{}'::jsonb,
  tags ARRAY DEFAULT '{}'::text[],
  is_active boolean NOT NULL DEFAULT true,
  created_by_program_member_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  exercise_id uuid,
  CONSTRAINT training_event_templates_pkey PRIMARY KEY (id),
  CONSTRAINT training_event_templates_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT training_event_templates_event_code_fkey FOREIGN KEY (event_code) REFERENCES public.event_definitions(event_code),
  CONSTRAINT training_event_templates_created_by_program_member_id_fkey FOREIGN KEY (created_by_program_member_id) REFERENCES public.program_members(id),
  CONSTRAINT training_event_templates_exercise_id_fkey FOREIGN KEY (exercise_id) REFERENCES public.training_exercises(id)
);
CREATE TABLE public.training_exercises (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid,
  label text NOT NULL,
  description text,
  workout_category text NOT NULL CHECK (workout_category = ANY (ARRAY['run'::text, 'gym'::text, 'cross_training'::text, 'other'::text])),
  measurement_unit text NOT NULL CHECK (measurement_unit = ANY (ARRAY['meters'::text, 'seconds'::text, 'reps'::text, 'mixed'::text, 'none'::text])),
  tags ARRAY NOT NULL DEFAULT '{}'::text[],
  is_active boolean NOT NULL DEFAULT true,
  metadata jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT training_exercises_pkey PRIMARY KEY (id)
);
CREATE TABLE public.transfer_portal_entries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  athlete_id uuid NOT NULL,
  current_program_id uuid NOT NULL,
  recruiting_profile_id uuid,
  active boolean NOT NULL DEFAULT true,
  entered_at timestamp with time zone NOT NULL DEFAULT now(),
  withdrawn_at timestamp with time zone,
  notes text,
  CONSTRAINT transfer_portal_entries_pkey PRIMARY KEY (id),
  CONSTRAINT transfer_portal_entries_athlete_id_fkey FOREIGN KEY (athlete_id) REFERENCES public.athletes(id),
  CONSTRAINT transfer_portal_entries_current_program_id_fkey FOREIGN KEY (current_program_id) REFERENCES public.programs(id),
  CONSTRAINT transfer_portal_entries_recruiting_profile_id_fkey FOREIGN KEY (recruiting_profile_id) REFERENCES public.recruiting_profiles(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  auth_id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL,
  name text,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  user_subscription_tier USER-DEFINED,
  stripe_customer_id text,
  stripe_subscription_id text,
  user_billing_status USER-DEFINED,
  subscription_tier text,
  billing_status USER-DEFINED DEFAULT 'none'::billing_status_enum,
  ai_assistant_enabled boolean DEFAULT false,
  avatar_url text,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.workout_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workout_id uuid NOT NULL,
  step_index integer NOT NULL,
  training_event_template_id uuid,
  label text,
  parameters_override jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  exercise_id uuid,
  CONSTRAINT workout_steps_pkey PRIMARY KEY (id),
  CONSTRAINT workout_steps_workout_id_fkey FOREIGN KEY (workout_id) REFERENCES public.workouts(id),
  CONSTRAINT workout_steps_training_event_template_id_fkey FOREIGN KEY (training_event_template_id) REFERENCES public.training_event_templates(id),
  CONSTRAINT workout_steps_exercise_id_fkey FOREIGN KEY (exercise_id) REFERENCES public.training_exercises(id)
);
CREATE TABLE public.workouts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  program_id uuid NOT NULL,
  label text NOT NULL,
  description text,
  is_system_template boolean NOT NULL DEFAULT false,
  created_by_program_member_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  archived_at timestamp with time zone,
  CONSTRAINT workouts_pkey PRIMARY KEY (id),
  CONSTRAINT workouts_program_id_fkey FOREIGN KEY (program_id) REFERENCES public.programs(id),
  CONSTRAINT workouts_created_by_program_member_id_fkey FOREIGN KEY (created_by_program_member_id) REFERENCES public.program_members(id)
);